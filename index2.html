<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<script src="https://maps.google.cn/maps/api/js?key=AIzaSyA_FrfIceV_JYILsYCShrVo50r3HE7yvBw"></script>
<script src="node_modules/jimp/browser/lib/jimp.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
  }
  #map {
    width: 100%;
    height: 100%;
  }
</style>

<div id="map"></div>

<script>
  function wait(asyncDone, timeout) {
    var short = true;
    setTimeout(function () {
      short = false;
    }, timeout);
    while (short && !asyncDone()) {}
  }

  function MapType(tileSize, name) {
    this.maxZoom = 2;
    this.minZoom = -4;
    this.alt = 'Not yet discovered';
    this.tileSize = tileSize;
    this.name = name;
  }

  MapType.prototype.getTile = function (coord, zoom) {
    var z = Math.pow(2, zoom);
    var asyncFlag = false;
    var img = document.createElement('img');
    Jimp.read('tiles/voxelmap/images/z' + z + '/' + coord.x + ',' + coord.y + '.png', function (err, image) {
      console.log('read', coord.x, coord.y);
      image.getBase64(Jimp.AUTO, function (_, code) {
        img.setAttribute('src', code);
        asyncFlag = true;
        console.log('read', coord.x, coord.y, 'done');
      });
    });
    wait(function () {
      return asyncFlag;
    }, 5000);

    return img;
  };

  MapType.prototype.getTile2 = function (coord, zoom) {
    var z = Math.pow(2, zoom);
    var img = document.createElement('img');
    img.setAttribute('src', 'tiles/voxelmap/images/z' + z + '/' + coord.x + ',' + coord.y + '.png');
    return img;
  };

  var map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 0, lng: 0},
    zoom: 1,
    streetViewControl: false,
    zoomControl: true,
    panControl: false,
    scaleControl: false,
    mapTypeControlOptions: {
      mapTypeIds: ['custom']
    }
  });

  map.mapTypes.set('custom', new MapType(new google.maps.Size(256, 256), 'Original'));
</script>